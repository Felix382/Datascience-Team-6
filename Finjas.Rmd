---
title: "R Notebook"
output: html_notebook
---
---
title: "R Notebook"
output: html_notebook
---


```{r}
library(readr)
library(lubridate)
library(ggplot2)
library(dplyr)
library(leaps)
library (pracma)
library(readxl)

umsatzdaten <- read_csv("data/umsatzdaten_gekuerzt.csv")
kiwo<- read_csv("data/kiwo.csv")
feiertage <- read_csv("data/feiertage.csv")
Zeiten <- read_excel("data/Zeiten.xlsx")
feiertage <- read_csv("data/feiertage.csv")
wetter <- read_csv("data/wetter.csv")
niederschlag <- read_csv("data/Niederschlag ja-nein.csv")
niederschlagsmenge <- read_csv("data/Niederschlagsmenge.csv")
sonnenschein <- read_csv("data/Sonnenscheindauer.csv")

merger<-left_join(umsatzdaten,kiwo)
Zeiten <- Zeiten %>% 
mutate(Datum = as.Date(Datum)) 
merger <- merger %>% 
mutate(Datum = as.Date(Datum)) 
merger2<-left_join(merger,Zeiten, by='Datum')
merger2[is.na(merger2)]<-0
merger2$wochentag <- weekdays(merger2$Datum)
merger3<-left_join(merger2,feiertage)
merger3[is.na(merger3)]<-0
merger4<-left_join(merger3, niederschlag, by='Datum')
merger5<-left_join(merger4, niederschlagsmenge, by='Datum')
merger6<-left_join(merger5, sonnenschein, by='Datum')


Dummy_Feiertag <- Dummy_Feiertag %>% mutate(Datum = as.Date(Datum)) 
final<-left_join (merger3, wetter)

#merger5<-left_join(merger4,)
#final<-left_join(merger4, merger1_2)
View(final)

#write.csv2(final, "dateiname.csv")
```



```{r}
#Dummy für Wochentage, Stena Line fährt jeden Tag

final%>%
mutate(Dummy = ifelse(wochentag=='Dienstag', "1", "0"))

final%>%
lag(feiertage, k=1)
  

movag<-movavg(wetter$Temperatur, 7, type=c("s"))


####UNDER CONSTRUCTION####
#Moving Average
# Function ma() calculates the moving average of order n
ma <- function(x, n = 7) { filter(x, rep(1/n,n), sides = 7, method = "convolution") }

for (Datum in final) {
  
}

movingaverage <- data.frame(final$Datum, "Moving Average")
# Calculate moving averages of order 7
ma7 <- ma(final$Umsatz, 7)

```

Balkendiagramm Beispiel 
```{r}
plot_warengruppe <- function(WG) {
  
  umsatzWGMo <- c(umsatz[Warengruppe == WG & wday(ymd(Datum)) == 1]$Umsatz)
  umsatzWGDi <- c(umsatz[Warengruppe == WG & wday(ymd(Datum)) == 2]$Umsatz)
  umsatzWGMi <- c(umsatz[Warengruppe == WG & wday(ymd(Datum)) == 3]$Umsatz)
  umsatzWGDo <- c(umsatz[Warengruppe == WG & wday(ymd(Datum)) == 4]$Umsatz)
  umsatzWGFr <- c(umsatz[Warengruppe == WG & wday(ymd(Datum)) == 5]$Umsatz)
  umsatzWGSa <- c(umsatz[Warengruppe == WG & wday(ymd(Datum)) == 6]$Umsatz)
  umsatzWGSo <- c(umsatz[Warengruppe == WG & wday(ymd(Datum)) == 7]$Umsatz)
  data <- data.frame(
    WG1 = c("Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"),
    value = c(mean(umsatzWGMo), mean(umsatzWGDi), mean(umsatzWGMi), mean(umsatzWGDo), mean(umsatzWGFr), mean(umsatzWGSa), mean(umsatzWGSo)),
    sd = c(sd(umsatzWGMo), sd(umsatzWGDi) , sd(umsatzWGMi) , sd(umsatzWGDo) , sd(umsatzWGFr) , sd(umsatzWGSa), sd(umsatzWGSo))
  )
  
  ggplot(data) + 
    geom_bar( aes(x = WG1, y = value), stat="identity", fill="skyblue", alpha=0.7) +
    geom_errorbar( aes(x = WG1, ymin = value - sd, ymax = value + sd), width = 0.4, colour ="orange", alpha= 0.9, size = 1.3) + 
    scale_x_discrete(paste("Warengruppe ", WG))
}

plot_warengruppe(1)

```

Sollten einen Dummy für vor oder nach Feiertag nehmen, Tage vor dem eigentlichen verkauf mit reinnehmen

Lineare Regression
```{r}
mod<- lm(Umsatz~KielerWoche+ Ferien+ wochentag + Feiertag + Temperatur+as.factor(Warengruppe)+ Bewoelkung+ Vor+ Nach,final)
summary(mod)

```



Subsets
```{r}
y <- regsubsets(Umsatz ~ ., final, nvmax=10)
summary(y)

```

